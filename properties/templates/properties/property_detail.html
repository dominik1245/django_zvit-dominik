{% extends 'base.html' %}
{% load static %}
{% load property_extras %}

{% block title %}{{ property.title }} - Dobre Wohnka{% endblock %}

{% block content %}
<section class="property-detail">
    <div class="wrap">
        <!-- Breadcrumbs -->
        <div class="breadcrumbs">
            <a href="{% url 'properties:home' %}"><i class="fas fa-home"></i> Головна</a>
            <span>/</span>
            <a href="{% url 'properties:property_list' %}">Оголошення</a>
            <span>/</span>
            <span>{{ property.title }}</span>
        </div>
        
        <div class="detail-grid">
            <!-- Left Column: Images -->
            <div class="detail-images">
                {% if property.images.exists %}
                    <div class="main-image">
                        {% with property.images.first as first_image %}
                        {% if first_image.get_image_source %}
                        <img src="{{ first_image.get_image_source }}" alt="{{ property.title }}" id="mainImage" style="width: 100%; max-height: 500px; object-fit: cover;">
                        {% else %}
                        <img src="{% static property|get_property_image %}" alt="{{ property.title }}" id="mainImage" style="width: 100%; max-height: 500px; object-fit: cover;">
                        {% endif %}
                        {% endwith %}
                        <div class="image-badge">
                            {% if property.property_type == 'sale' %}
                            <span class="badge badge-sale"><i class="fas fa-tags"></i> Продаж</span>
                            {% else %}
                            <span class="badge badge-rent"><i class="fas fa-key"></i> Оренда</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if property.images.count > 1 %}
                    <div class="image-gallery">
                        {% for image in property.images.all %}
                        <div class="gallery-item {% if forloop.first %}active{% endif %}" onclick="changeImage('{{ image.get_image_source }}', this)">
                            {% if image.get_image_source %}
                            <img src="{{ image.get_image_source }}" alt="Фото {{ forloop.counter }}" style="width: 100%; height: 80px; object-fit: cover; cursor: pointer;">
                            {% else %}
                            <div class="gallery-placeholder" style="width: 100%; height: 80px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                <i class="fas fa-image" style="font-size: 24px; color: #999;"></i>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <div class="detail-placeholder" style="width: 100%; height: 500px; background: #f5f5f5; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;">
                        <i class="fas fa-home" style="font-size: 64px; color: #ccc; margin-bottom: 20px;"></i>
                        <p style="color: #999; font-size: 18px;">Зображення відсутнє</p>
                        <img src="{% static property|get_property_image %}" alt="{{ property.title }}" style="max-width: 100%; max-height: 300px; margin-top: 20px; object-fit: contain;">
                    </div>
                {% endif %}
            </div>
            
            <!-- Right Column: Info -->
            <div class="detail-info">
                <h1 class="detail-title">{{ property.title }}</h1>
                
                <div class="detail-location">
                    <i class="fas fa-map-marker-alt"></i>
                    {{ property.city }}{% if property.address %}, {{ property.address }}{% endif %}
                </div>
                
                <div class="detail-price">
                    <span class="price-amount">{{ property.price|floatformat:0 }} {{ property.get_currency_symbol }}</span>
                    <span class="price-label">{% if property.property_type == 'rent' %}/ місяць{% endif %}</span>
                </div>
                
                <div class="detail-features">
                    {% if property.rooms %}
                    <div class="feature-item">
                        <i class="fas fa-door-open"></i>
                        <div>
                            <strong>{{ property.rooms }}</strong>
                            <span>Кімнат</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if property.area %}
                    <div class="feature-item">
                        <i class="fas fa-ruler-combined"></i>
                        <div>
                            <strong>{{ property.area }} м²</strong>
                            <span>Площа</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if property.floor %}
                    <div class="feature-item">
                        <i class="fas fa-layer-group"></i>
                        <div>
                            <strong>{{ property.floor }}{% if property.total_floors %}/{{ property.total_floors }}{% endif %}</strong>
                            <span>Поверх</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if property.bedrooms %}
                    <div class="feature-item">
                        <i class="fas fa-bed"></i>
                        <div>
                            <strong>{{ property.bedrooms }}</strong>
                            <span>Спальні</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="detail-description">
                    <h2><i class="fas fa-info-circle"></i> Опис</h2>
                    <p>{{ property.description }}</p>
                </div>
                
                <div class="detail-amenities">
                    <h3><i class="fas fa-check-circle"></i> Додаткові характеристики</h3>
                    <div class="amenities-grid">
                        {% if property.balcony %}
                        <div class="amenity-item">
                            <i class="fas fa-check"></i> Балкон
                        </div>
                        {% endif %}
                        {% if property.parking %}
                        <div class="amenity-item">
                            <i class="fas fa-check"></i> Паркінг
                        </div>
                        {% endif %}
                        {% if property.elevator %}
                        <div class="amenity-item">
                            <i class="fas fa-check"></i> Ліфт
                        </div>
                        {% endif %}
                        {% if property.furniture != 'unknown' %}
                        <div class="amenity-item">
                            <i class="fas fa-check"></i> {{ property.get_furniture_display }}
                        </div>
                        {% endif %}
                        {% if property.repair %}
                        <div class="amenity-item">
                            <i class="fas fa-check"></i> {{ property.get_repair_display }}
                        </div>
                        {% endif %}
                        {% if property.building_type %}
                        <div class="amenity-item">
                            <i class="fas fa-check"></i> {{ property.get_building_type_display }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="contact-section">
                    <h3><i class="fas fa-phone"></i> Контактна інформація</h3>
                    <div class="contact-details">
                        {% if property.contact_name %}
                        <p><strong>Контактна особа:</strong> {{ property.contact_name }}</p>
                        {% endif %}
                        <p><strong>Телефон:</strong> <a href="tel:{{ property.contact_phone }}">{{ property.contact_phone }}</a></p>
                        {% if property.contact_email %}
                        <p><strong>Email:</strong> <a href="mailto:{{ property.contact_email }}">{{ property.contact_email }}</a></p>
                        {% endif %}
                    </div>
                    
                    <div class="contact-buttons">
                        <a href="tel:{{ property.contact_phone }}" class="btn btn-primary btn-large">
                            <i class="fas fa-phone"></i> Зателефонувати
                        </a>
                        <a href="https://wa.me/{{ property.contact_phone }}" target="_blank" class="btn btn-outline btn-large">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    </div>
                </div>
                
                <div class="property-meta">
                    <p><i class="fas fa-eye"></i> Переглядів: {{ property.views_count }}</p>
                    <p><i class="fas fa-calendar"></i> Опубліковано: {{ property.created_at|date:"d.m.Y" }}</p>
                </div>
                
                <div class="add-photos-section">
                    <a href="{% url 'properties:add_internet_photos' property.id %}" class="btn btn-outline">
                        <i class="fas fa-globe"></i> Додати фото з інтернету
                    </a>
                </div>
                
                <div class="admin-actions">
                    <h3><i class="fas fa-tools"></i> Дії з оголошенням</h3>
                    <div class="action-buttons">
                        <a href="{% url 'properties:property_update' property.pk %}" class="btn btn-primary">
                            <i class="fas fa-edit"></i> Редагувати оголошення
                        </a>
                        <a href="{% url 'properties:property_delete' property.pk %}" class="btn btn-danger" onclick="return confirm('Ви впевнені, що хочете видалити це оголошення?')">
                            <i class="fas fa-trash"></i> Видалити оголошення
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Similar Properties -->
        {% if similar_properties %}
        <section class="similar-section">
            <h2>Схожі оголошення</h2>
            <div class="properties-grid">
                {% for prop in similar_properties %}
                <article class="property-card">
                    <div class="property-badge">
                        {% if prop.property_type == 'sale' %}
                        <span class="badge badge-sale"><i class="fas fa-tags"></i> Продаж</span>
                        {% else %}
                        <span class="badge badge-rent"><i class="fas fa-key"></i> Оренда</span>
                        {% endif %}
                    </div>
                    
                    <div class="property-image">
                        {% if prop.images.exists %}
                            {% with prop.images.first as first_image %}
                            {% if first_image.get_image_source %}
                            <img src="{{ first_image.get_image_source }}" alt="{{ prop.title }}">
                            {% else %}
                            <div class="property-placeholder">
                                <i class="fas fa-home"></i>
                            </div>
                            {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="property-placeholder">
                                <i class="fas fa-home"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="property-body">
                        <h3 class="property-title">{{ prop.title }}</h3>
                        
                        <div class="property-location">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ prop.city }}
                        </div>
                        
                        <div class="property-price">
                            {{ prop.price|floatformat:0 }} {{ prop.get_currency_symbol }}
                        </div>
                        
                        <div class="property-features">
                            {% if prop.rooms %}
                            <span><i class="fas fa-door-open"></i> {{ prop.rooms }} кім.</span>
                            {% endif %}
                            {% if prop.area %}
                            <span><i class="fas fa-ruler-combined"></i> {{ prop.area }} м²</span>
                            {% endif %}
                        </div>
                        
                        <a href="{% url 'properties:property_detail' prop.pk %}" class="btn btn-primary btn-full">
                            Детальніше <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </article>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>
</section>

<script>
function changeImage(url, element) {
    const mainImage = document.getElementById('mainImage');
    if (url) {
        mainImage.src = url;
    } else {
        // Якщо URL відсутній, використовуємо зображення за замовчуванням
        const defaultImage = '{{ "properties/images/"|add:property|get_property_image }}';
        mainImage.src = '{% static "" %}' + defaultImage;
    }
    
    // Оновлюємо активний елемент галереї
    document.querySelectorAll('.gallery-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
    
    // Плавний скрол до верхньої частини зображення
    mainImage.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Додаємо обробник подій для всіх мініатюр після завантаження сторінки
document.addEventListener('DOMContentLoaded', function() {
    const galleryItems = document.querySelectorAll('.gallery-item');
    galleryItems.forEach(item => {
        item.addEventListener('click', function() {
            const img = this.querySelector('img');
            if (img) {
                changeImage(img.src, this);
            } else {
                // Якщо клікнули на placeholder, використовуємо зображення за замовчуванням
                const defaultImage = '{{ "properties/images/"|add:property|get_property_image }}';
                changeImage('{% static "" %}' + defaultImage, this);
            }
        });
    });
});
</script>
{% endblock %}
